;
; AssemblerProject1_Optimized.asm
; Created: 2025/11/28 17:46:57
; Author : smi
; Target: ATtiny10
; Clock: 8MHz (Derived from code)
; Function: PWM Waveform Generator (Likely Sine wave on PB0/PB1)

.device ATtiny10
.cseg
.org 0x0000

RESET:
    ; --- システムクロック設定 (8MHz) ---
    LDI     r16, 0xD8       ; CCP書き込みキー
    OUT     CCP, r16
    LDI     r16, 0x00       ; 分周なし
    OUT     CLKPSR, r16

    ; --- スタックポインタ設定 ---
    OUT     SPH, r16        ; SPH = 0
    LDI     r16, low(RAMEND)
    OUT     SPL, r16

    ; --- I/O設定 ---
    ; PB0=OC0A, PB1=OC0B (タイマー出力ピン)として出力設定
    LDI     r16, 0x03       ; PB0, PB1を出力設定 (0b00000011)
    OUT     DDRB, r16

    ; --- タイマー0設定 (Phase Correct PWM, 8-bit) ---
    ; COM0A1:0=10, COM0B1:0=10 (非反転), WGM01:0=01
    LDI     r16, 0xA1
    OUT     TCCR0A, r16
    ; WGM03:2=00, CS02:0=001 (分周なし)
    LDI     r16, 0x01
    OUT     TCCR0B, r16

    ; --- ポインタ初期化 ---
    ; Flash先頭(0x4000) + データオフセット(0x0100) = 0x4100
    LDI     XH, 0x41
    LDI     XL, 0x00        ; Phase 0

    LDI     YH, 0x41
    LDI     YL, 0x55        ; Phase +85 (約120度位相差)

    ; --- メインループ ---
loop:
    ; データ読み出し (ロード & インクリメント)
    LD      r16, X+
    LD      r17, Y+

    ; PWM更新
    OUT     OCR0AL, r16     ; PB0
    OUT     OCR0BL, r17     ; PB1

    ; ポインタ補正 (256バイトループ)
    ; X+, Y+で下位バイトがオーバーフロー(FF->00)すると上位バイト(XH/YH)が
    ; インクリメント(41->42)されてしまうため、強制的に0x41に戻す
    LDI     r18, 0x41
    MOV     XH, r18
    MOV     YH, r18

    RJMP    loop

; --- 波形データ (256バイト) ---
.org 0x0080 ; Byte Address 0x0100
SineTable:
    .db 0x7F, 0x82, 0x85, 0x88, 0x8B, 0x8F, 0x92, 0x95
    .db 0x98, 0x9B, 0x9E, 0xA1, 0xA4, 0xA7, 0xAA, 0xAD
    .db 0xB0, 0xB3, 0xB6, 0xB8, 0xBB, 0xBE, 0xC1, 0xC3
    .db 0xC6, 0xC8, 0xCB, 0xCD, 0xD0, 0xD2, 0xD5, 0xD7
    .db 0xD9, 0xDB, 0xDD, 0xE0, 0xE2, 0xE4, 0xE5, 0xE7
    .db 0xE9, 0xEB, 0xEC, 0xEE, 0xEF, 0xF1, 0xF2, 0xF4
    .db 0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB, 0xFB
    .db 0xFC, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE
    .db 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFD, 0xFD
    .db 0xFC, 0xFB, 0xFB, 0xFA, 0xF9, 0xF8, 0xF7, 0xF6
    .db 0xF5, 0xF4, 0xF2, 0xF1, 0xEF, 0xEE, 0xEC, 0xEB
    .db 0xE9, 0xE7, 0xE5, 0xE4, 0xE2, 0xE0, 0xDD, 0xDB
    .db 0xD9, 0xD7, 0xD5, 0xD2, 0xD0, 0xCD, 0xCB, 0xC8
    .db 0xC6, 0xC3, 0xC1, 0xBE, 0xBB, 0xB8, 0xB6, 0xB3
    .db 0xB0, 0xAD, 0xAA, 0xA7, 0xA4, 0xA1, 0x9E, 0x9B
    .db 0x98, 0x95, 0x92, 0x8F, 0x8B, 0x88, 0x85, 0x82
    .db 0x7F, 0x7C, 0x79, 0x76, 0x73, 0x6F, 0x6C, 0x69
    .db 0x66, 0x63, 0x60, 0x5D, 0x5A, 0x57, 0x54, 0x51
    .db 0x4E, 0x4B, 0x48, 0x46, 0x43, 0x40, 0x3D, 0x3B
    .db 0x38, 0x36, 0x33, 0x31, 0x2E, 0x2C, 0x29, 0x27
    .db 0x25, 0x23, 0x21, 0x1E, 0x1C, 0x1A, 0x19, 0x17
    .db 0x15, 0x13, 0x12, 0x10, 0x0F, 0x0D, 0x0C, 0x0A
    .db 0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x03
    .db 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00
    .db 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02
    .db 0x03, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09
    .db 0x0A, 0x0C, 0x0D, 0x0F, 0x10, 0x12, 0x13, 0x15
    .db 0x17, 0x19, 0x1A, 0x1C, 0x1E, 0x21, 0x23, 0x25
    .db 0x27, 0x29, 0x2C, 0x2E, 0x31, 0x33, 0x36, 0x38
    .db 0x3B, 0x3D, 0x40, 0x43, 0x46, 0x48, 0x4B, 0x4E
    .db 0x51, 0x54, 0x57, 0x5A, 0x5D, 0x60, 0x63, 0x66
    .db 0x69, 0x6C, 0x6F, 0x73, 0x76, 0x79, 0x7C, 0x7F
    
